// =============================================================================
// VoxNexus Database Schema
// =============================================================================
// Copyright 2026 Cothink LLC. Licensed under Apache-2.0.
// =============================================================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

// =============================================================================
// Multi-Tenancy: Organizations & Users
// =============================================================================

model Organization {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  plan      String   @default("free") // free, pro, enterprise
  metadata  Json     @default("{}")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  users       OrganizationUser[]
  agents      AgentConfig[]
  apiKeys     ApiKey[]
  usageLogs   UsageLog[]

  @@map("organizations")
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  name          String?
  avatarUrl     String?  @map("avatar_url")
  passwordHash  String?  @map("password_hash")
  emailVerified Boolean  @default(false) @map("email_verified")
  metadata      Json     @default("{}")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  organizations OrganizationUser[]
  sessions      Session[]

  @@map("users")
}

model OrganizationUser {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  userId         String   @map("user_id")
  role           String   @default("member") // owner, admin, member
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@map("organization_users")
}

model Session {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@map("sessions")
}

// =============================================================================
// Agent Configuration
// =============================================================================

model AgentConfig {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  name           String
  description    String?
  isActive       Boolean  @default(true) @map("is_active")

  // Provider configurations stored as JSON
  llmConfig      Json     @default("{}") @map("llm_config")
  sttConfig      Json     @default("{}") @map("stt_config")
  ttsConfig      Json     @default("{}") @map("tts_config")

  // System prompt and persona
  systemPrompt   String?  @map("system_prompt") @db.Text
  persona        Json     @default("{}")

  // Webhook configurations
  webhooks       Json     @default("{}")

  // Tool definitions for function calling
  tools          Json     @default("[]")

  // Additional metadata
  metadata       Json     @default("{}")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  organization       Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  conversations      Conversation[]
  usageLogs          UsageLog[]
  knowledgeDocuments KnowledgeDocument[]
  sipDevices         SipDevice[]

  @@index([organizationId])
  @@index([isActive])
  @@map("agent_configs")
}

// =============================================================================
// Webhooks & Integrations
// =============================================================================

model WebhookEndpoint {
  id             String   @id @default(uuid())
  agentConfigId  String   @map("agent_config_id")
  name           String
  url            String
  method         String   @default("POST")
  headers        Json     @default("{}")
  secret         String?
  isActive       Boolean  @default(true) @map("is_active")
  timeoutMs      Int      @default(30000) @map("timeout_ms")
  retryCount     Int      @default(3) @map("retry_count")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@index([agentConfigId])
  @@map("webhook_endpoints")
}

// =============================================================================
// Conversations & Messages
// =============================================================================

model Conversation {
  id            String   @id @default(uuid())
  agentConfigId String   @map("agent_config_id")
  sessionId     String?  @map("session_id") // LiveKit room ID or external session
  status        String   @default("active") // active, completed, failed
  metadata      Json     @default("{}")
  startedAt     DateTime @default(now()) @map("started_at")
  endedAt       DateTime? @map("ended_at")

  // Relations
  agent    AgentConfig @relation(fields: [agentConfigId], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([agentConfigId])
  @@index([sessionId])
  @@index([status])
  @@map("conversations")
}

model Message {
  id             String   @id @default(uuid())
  conversationId String   @map("conversation_id")
  role           String   // system, user, assistant, tool
  content        String   @db.Text
  name           String?  // For tool messages
  toolCallId     String?  @map("tool_call_id")

  // Audio metadata (if voice message)
  audioUrl       String?  @map("audio_url")
  durationMs     Int?     @map("duration_ms")

  // Token usage tracking
  promptTokens   Int?     @map("prompt_tokens")
  outputTokens   Int?     @map("output_tokens")

  metadata       Json     @default("{}")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([role])
  @@map("messages")
}

// =============================================================================
// API Keys & Authentication
// =============================================================================

model ApiKey {
  id             String    @id @default(uuid())
  organizationId String    @map("organization_id")
  name           String
  keyHash        String    @unique @map("key_hash")
  keyPrefix      String    @map("key_prefix") // First 8 chars for display
  scopes         String[]  @default(["read", "write"])
  lastUsedAt     DateTime? @map("last_used_at")
  expiresAt      DateTime? @map("expires_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([keyHash])
  @@index([organizationId])
  @@map("api_keys")
}

// =============================================================================
// Usage Tracking & Analytics
// =============================================================================

model UsageLog {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  agentConfigId  String?  @map("agent_config_id")

  // What was used
  provider       String   // openai, anthropic, deepgram, etc.
  providerType   String   @map("provider_type") // llm, stt, tts
  model          String

  // Usage metrics
  inputTokens    Int?     @map("input_tokens")
  outputTokens   Int?     @map("output_tokens")
  audioDurationMs Int?    @map("audio_duration_ms")

  // Cost tracking (in microcents for precision)
  costMicrocents Int?     @map("cost_microcents")

  // Request metadata
  requestId      String?  @map("request_id")
  latencyMs      Int?     @map("latency_ms")
  success        Boolean  @default(true)
  errorMessage   String?  @map("error_message")

  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  agent        AgentConfig? @relation(fields: [agentConfigId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([agentConfigId])
  @@index([createdAt])
  @@index([provider])
  @@map("usage_logs")
}

// =============================================================================
// Provider Credentials (Encrypted at rest)
// =============================================================================

model ProviderCredential {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  provider       String   // openai, anthropic, deepgram, etc.
  credentialType String   @map("credential_type") // api_key, oauth_token, etc.

  // Encrypted credential value
  encryptedValue String   @map("encrypted_value") @db.Text
  iv             String   // Initialization vector for decryption

  isDefault      Boolean  @default(false) @map("is_default")
  metadata       Json     @default("{}")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@unique([organizationId, provider, credentialType])
  @@index([organizationId])
  @@map("provider_credentials")
}

// =============================================================================
// RAG Knowledge Base
// =============================================================================

model KnowledgeDocument {
  id            String   @id @default(uuid())
  agentConfigId String   @map("agent_config_id")
  filename      String
  chunkIndex    Int      @default(0) @map("chunk_index")
  content       String   @db.Text
  // Embedding stored via raw SQL (Prisma doesn't fully support vector types)
  // embedding  vector(1536) - managed via raw queries
  tokenCount    Int?     @map("token_count")
  metadata      Json     @default("{}")
  status        String   @default("processing") // processing, ready, failed
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  agent AgentConfig @relation(fields: [agentConfigId], references: [id], onDelete: Cascade)

  @@index([agentConfigId])
  @@index([status])
  @@index([filename])
  @@map("knowledge_documents")
}

// =============================================================================
// SIP/Telephony Integration
// =============================================================================

enum SipDeviceStatus {
  REGISTERED
  FAILED
  OFFLINE
}

model SipDevice {
  id            String          @id @default(uuid())
  agentConfigId String          @map("agent_config_id")

  // SIP Registration credentials
  server        String          // SIP server hostname (e.g., sip.company.com)
  username      String          // SIP extension/username
  password      String          // SIP password (encrypted at rest via app layer)
  port          Int             @default(5060)
  transport     String          @default("udp") // udp, tcp, tls

  // Registration state
  status        SipDeviceStatus @default(OFFLINE)
  lastError     String?         @map("last_error")
  registeredAt  DateTime?       @map("registered_at")

  // Display name for caller ID
  displayName   String?         @map("display_name")

  // Additional SIP settings
  realm         String?         // Authentication realm (usually same as server)
  outboundProxy String?         @map("outbound_proxy")

  metadata      Json            @default("{}")
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  // Relations
  agent     AgentConfig @relation(fields: [agentConfigId], references: [id], onDelete: Cascade)
  callLogs  SipCallLog[]

  @@unique([server, username]) // Prevent duplicate registrations
  @@index([agentConfigId])
  @@index([status])
  @@map("sip_devices")
}

model SipCallLog {
  id           String   @id @default(uuid())
  sipDeviceId  String   @map("sip_device_id")

  // Call details
  callId       String   @map("call_id") // SIP Call-ID header
  direction    String   // inbound, outbound
  remoteUri    String   @map("remote_uri") // sip:caller@domain
  remoteName   String?  @map("remote_name") // Caller ID name

  // LiveKit integration
  livekitRoom  String?  @map("livekit_room") // Room name for bridging

  // Call state
  status       String   @default("ringing") // ringing, answered, completed, failed, missed
  startedAt    DateTime @default(now()) @map("started_at")
  answeredAt   DateTime? @map("answered_at")
  endedAt      DateTime? @map("ended_at")
  durationSecs Int?     @map("duration_secs")

  // Termination reason
  hangupCause  String?  @map("hangup_cause")

  metadata     Json     @default("{}")

  // Relations
  sipDevice SipDevice @relation(fields: [sipDeviceId], references: [id], onDelete: Cascade)

  @@index([sipDeviceId])
  @@index([callId])
  @@index([status])
  @@index([startedAt])
  @@map("sip_call_logs")
}
